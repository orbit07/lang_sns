<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">
<title>Mew</title>
<style>
:root { --gap:12px; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --bg:#e8e3ec91; }
* { box-sizing: border-box; }
body { margin:0; font-size:13px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); }
header { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 14px; display:flex; align-items:center; gap:10px; z-index:2; }
header h1 { font-size:1.1rem; margin:0; }
main { max-width:720px; margin:0 auto; padding:14px; }
.card { background:var(--card); border-radius:14px; padding:12px; }
.composer { display:grid; gap:var(--gap); }
textarea { width:100%; min-height:96px; padding:10px; font-size:.8rem; resize:vertical; border: 2px solid #e8e3ec96; border-radius: 10px; }
.row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content: space-between; }
.lang-chip { display:none; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fafafa; font-size:.9rem; }
.langBox { display: flex; justify-content: space-between; }
.btn { text-decoration: none; padding:0; border:none; border-radius:20px; box-sizing: border-box; background:none; cursor:pointer; }
.btn_img { border: none; }
.btn:active { transform: translateY(1px); }
.btn.lang { border: 1px solid #ccc; padding: 4px 12px; display: flex; gap: 4px; }
.btn.primary { border: 2px solid #ae4a74; background:#ae4a74; color:#fff; padding: 3px 40px; display: flex; gap: 5px;}
.btn.clear { border: 2px solid #ae4a74; color:#ae4a74; padding: 3px 20px; }
.btn.danger { border-color:#ef4444; color:#ef4444; }
.small { font-size:.7rem; color:var(--muted); }
.grid { display:grid; gap:10px; }
.post { display:grid; gap:8px; }
.meta { display:flex; gap:8px; color:var(--muted); font-size:.8rem; }
.content { white-space:pre-wrap; word-break:break-word; }
.img { width:100%; border-radius:12px; border:1px solid var(--border); background:#f3f4f6; object-fit:cover; max-height:420px; }
.section { border: none; background: #e8e3ec52; border-radius:12px; padding:10px; }
details summary { cursor:pointer; }
.toolbar { position:sticky; bottom:10px; display:flex; gap:40px; margin-top:8px; padding: 5px 12px;}
.list { display:grid; gap:12px; margin-top:12px; }
.phrase { display:flex; align-items:center; gap:5px; }
.sep { height:1px; background:var(--border); margin:8px 0; }
.pill { font-size:.85rem; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#f9fafb; }
.lang-block { padding:10px; border-radius:10px; background: #e8e3ec52; }
.lang-block h4 { margin:0 0 6px; font-size:.9rem; display:flex; justify-content:space-between; }
.hl { font-weight:600; }
.actions { display:flex; gap:8px; flex-wrap:wrap; }
.notice { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px; border-radius:10px; }
.other { padding-top: 10px; display: flex; flex-direction: column; gap: 8px; padding-left: 15px;}
</style>
</head>
<body>

<!-- ä»»æ„: ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã†å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤
<header>
<h1>My Speak SNSï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ï¼‰</h1>
<span class="pill">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³OK</span>
</header>
-->

<main>
    <!-- ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card composer">
        <img id="preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width:100%;margin-top:8px;border-radius:12px;display:none;">

        <div class="grid">
            <div class="langBox">
                <label for="image" class="btn btn_img" title="ç”»åƒã‚’é¸æŠ">
                <img src="assets/img/img.svg" alt="ç”»åƒã‚’é¸æŠ" style="width:24px;height:24px;vertical-align:middle;">
                </label>
                <input id="image" type="file" accept="image/*" style="display:none;">
                <button class="btn lang" id="addJa"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="15" style="display:flex">ja</button>
                <button class="btn lang" id="addEn"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="15" style="display:flex">en</button>
                <button class="btn lang" id="addKo"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="15" style="display:flex">ko</button>
                <button class="btn lang" id="addZh"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="15" style="display:flex">zh-TW</button>
            </div>
            <div id="langArea" class="grid"></div>
        </div>

        <div class="row">
            <button class="btn clear" id="clearComposer">Clear</button>
            <button class="btn primary" id="postBtn"><img src="assets/img/cat.svg" alt="cat" width="15" style="display:flex">Post</button>
        </div>
    </div>

    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="list" id="list"></div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ/å…¨å‰Šé™¤ï¼‰ -->
    <div class="toolbar">
        <button class="btn danger" id="purgeBtn" title="å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤"><img src="assets/img/batsu.svg" alt="ãƒãƒ„" width="15" style="display:flex"></button>
        <button class="btn" id="exportBtn" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"><img src="assets/img/export.svg" alt="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ" width="15" style="display:flex"></button>
        <input type="file" id="importFile" accept="application/json" style="display:none;">
        <button class="btn" id="importBtn" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"><img src="assets/img/import.svg" alt="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ" width="15" style="display:flex"></button>
    </div>

    <p class="small">ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
</main>

<script>
/** ================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ================== */
const DB_KEY = "myspeak_sns_posts_v1";
const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; // iOS åˆ¤å®š
const TL = { "ja":"ja", "ko":"ko", "zh-TW":"zh-TW", "en":"en" }; // Googleç¿»è¨³ã® tl

function buildTranslateLinks(text, tl){
    const encoded = encodeURIComponent(text);
    const app = `googletranslate://?sl=auto&tl=${encodeURIComponent(tl)}&text=${encoded}`;
    const web = `https://translate.google.com/?sl=auto&tl=${encodeURIComponent(tl)}&text=${encoded}&op=translate`;
    return { app, web };
}

// iOS: ã¾ãšã‚¢ãƒ—ãƒª â†’ å¤±æ•—æ™‚ Web ã¸ã®å®‰å®šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
function createSpeakButton(text, tl) {
    const { app, web } = buildTranslateLinks(text, tl);
    const a = document.createElement("a");
    a.className = "btn";
    a.innerHTML = `<img src="assets/img/speaker.svg" alt="ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼" width="15" style="display:flex">`;

    // iOS ä»¥å¤–ã¯å˜ç´”ã« Web ã¸
    if (!isiOS) {
        a.href = web;
        a.target = "_blank";
        a.rel = "noopener";
        return a;
    }

    // iOS: ã¾ãšã‚¢ãƒ—ãƒª â†’ å¤±æ•—æ™‚ Web
    a.href = app; // é•·æŠ¼ã—å¯¾ç­–

    a.addEventListener("click", (e) => {
        e.preventDefault();

        let openedByApp = false;
        const handleVisibility = () => {
            if (document.hidden) {
                openedByApp = true;
                cleanup();
            }
        };

        // â˜… ã“ã“ã‹ã‚‰å…ˆã¯ã€Œã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã€ã«ã ã‘ã‚»ãƒƒãƒˆã™ã‚‹
        document.addEventListener("visibilitychange", handleVisibility, { once: true });

        const t = setTimeout(() => {
            if (!openedByApp) {
                window.open(web, "_blank", "noopener"); // ã‚¢ãƒ—ãƒªç„¡ã„/å¤±æ•— â†’ Web
            }
            cleanup();
        }, 700);

        function cleanup() {
            clearTimeout(t);
            document.removeEventListener("visibilitychange", handleVisibility);
        }

        // ã¾ãšã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«é–‹ã
        window.location.href = app;
    });

    return a;
}


function loadPosts(){ try { return JSON.parse(localStorage.getItem(DB_KEY) || "[]"); } catch { return []; } }
function savePosts(arr){ localStorage.setItem(DB_KEY, JSON.stringify(arr)); }

function fileToDataURL(file){
    return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
    });
}
function rid(){ return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2); }

/** =============== ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè¨€èªãƒ–ãƒ­ãƒƒã‚¯ï¼‰ =============== */
const $langArea = document.getElementById("langArea");
function addLangBlock(lang){
    const id = rid();
    const $wrap = document.createElement("div");
    $wrap.className = "lang-block";
    $wrap.dataset.lang = lang;
    $wrap.dataset.id = id;
    $wrap.innerHTML = `
        <h4>${langLabel(lang)} <button class="btn small" data-act="remove"><img src="assets/img/batsu.svg" alt="ãƒãƒ„" width="15" style="display:flex"></button></h4>
        <div class="grid">
        <label>ãƒ¡ã‚¤ãƒ³ã®è¨€è‘‰<textarea data-field="main" placeholder="ä¾‹ï¼‰I had ramen for lunch."></textarea></label>
        <details>
            <summary class="small">ãŠã™ã™ã‚ã®è¨€ã„æ›ãˆï¼ˆ0ã€œ3ï¼‰</summary>
            <div class="grid" style="margin-top:8px;">
            <textarea data-field="alt1" placeholder="è¨€ã„æ›ãˆ1ï¼ˆä»»æ„ï¼‰"></textarea>
            <textarea data-field="alt2" placeholder="è¨€ã„æ›ãˆ2ï¼ˆä»»æ„ï¼‰"></textarea>
            <textarea data-field="alt3" placeholder="è¨€ã„æ›ãˆ3ï¼ˆä»»æ„ï¼‰"></textarea>
            </div>
        </details>
        </div>
    `;
    $wrap.addEventListener("click", (e)=>{ if(e.target.closest("[data-act='remove']")) $wrap.remove(); });
    $langArea.appendChild($wrap);
}
function langLabel(lang){
    switch(lang){
        case "ja": return "æ—¥æœ¬èªï¼ˆja)";
        case "ko": return "éŸ“å›½èªï¼ˆko)";
        case "zh-TW": return "å°æ¹¾è¯èªï¼ˆzh-TW)";
        case "en": return "è‹±èªï¼ˆen)";
        default: return lang;
    }
}

/** =============== ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =============== */
const $image = document.getElementById("image");
const $preview = document.getElementById("preview");
$image.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) { $preview.style.display = "none"; return; }
    const reader = new FileReader();
    reader.onload = () => { $preview.src = reader.result; $preview.style.display = "block"; };
    reader.readAsDataURL(file);
});

/** =============== æŠ•ç¨¿ä½œæˆ =============== */
const $postBtn = document.getElementById("postBtn");
const $clearComposer = document.getElementById("clearComposer");
document.getElementById("addJa").onclick = ()=>addLangBlock("ja");
document.getElementById("addKo").onclick = ()=>addLangBlock("ko");
document.getElementById("addZh").onclick = ()=>addLangBlock("zh-TW");
document.getElementById("addEn").onclick = ()=>addLangBlock("en");

$postBtn.addEventListener("click", async ()=>{
    const blocks = Array.from($langArea.querySelectorAll(".lang-block")).map($b=>{
        const lang = $b.dataset.lang;
        const get = (sel)=>($b.querySelector(`[data-field='${sel}']`)?.value || "").trim();
        const main = get("main");
        const alt = [get("alt1"), get("alt2"), get("alt3")].filter(Boolean);
        return { lang, main, alt };
    }).filter(b=>b.lang && b.main);

    if(!blocks.length){ alert("å°‘ãªãã¨ã‚‚1ã¤ã®è¨€èªãƒ–ãƒ­ãƒƒã‚¯ã§ã€ãƒ¡ã‚¤ãƒ³ã®è¨€è‘‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

    let imgDataUrl = "";
    const file = $image.files?.[0];
    if(file){ try { imgDataUrl = await fileToDataURL(file); } catch { alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); return; } }

    const post = { id: rid(), created: Date.now(), image: imgDataUrl, blocks };
    const posts = loadPosts();
    posts.push(post);
    savePosts(posts);

    $image.value = ""; // åˆæœŸåŒ–
    $langArea.innerHTML = "";
    $preview.style.display = "none";
    renderList();
});

$clearComposer.addEventListener("click", ()=>{ $image.value = ""; $langArea.innerHTML = ""; $preview.style.display = "none"; });

/** =============== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» =============== */
const $list = document.getElementById("list");
function renderList(){
    const posts = loadPosts().sort((a,b)=>b.created - a.created);
    $list.innerHTML = "";

    if(!posts.length){
        const $n = document.createElement("div");
        $n.className = "notice";
        $n.textContent = "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚";
        $list.appendChild($n);
        return;
    }

    for(const p of posts){
        const $card = document.createElement("div");
        $card.className = "card post";

        if(p.image){
            const $img = document.createElement("img");
            $img.className = "img";
            $img.src = p.image;
            $img.alt = "æŠ•ç¨¿ç”»åƒ";
            $card.appendChild($img);
        }

        for(const b of p.blocks){
            const $sec = document.createElement("div");
            $sec.className = "section";

            // è¨€èªãƒ©ãƒ™ãƒ«
            const $title = document.createElement("div");
            $title.className = "row";
            const $chip = document.createElement("span");
            $chip.className = "lang-chip";
            $chip.textContent = langLabel(b.lang);
            $title.appendChild($chip);
            $sec.appendChild($title);

            // æœ¬æ–‡ï¼ˆğŸ”Šâ†’ãƒ†ã‚­ã‚¹ãƒˆï¼‰
            const mainStr = (b.main ?? "").toString().trim();
            if (mainStr) {
                const $mainRow = document.createElement("div");
                $mainRow.className = "phrase";
                if (b.lang !== "ja") $mainRow.appendChild(createSpeakButton(mainStr, TL[b.lang]));
                const $mainText = document.createElement("div");
                $mainText.className = "content";
                $mainText.textContent = mainStr;
                $mainRow.appendChild($mainText);
                $sec.appendChild($mainRow);
            }

            // è¨€ã„æ›ãˆ
            if (Array.isArray(b.alt) && b.alt.length) {
                const $alts = document.createElement("div");
                $alts.className = "other";
                const $sum = document.createElement("div");
                $sum.className = "small hl";
                $sum.textContent = "ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³";
                $alts.appendChild($sum);

                for (const raw of b.alt) {
                    const t = (raw ?? "").toString().trim();
                    if (!t) continue;
                    if (b.lang !== "ja") {
                        const $phrase = document.createElement("div");
                        $phrase.className = "phrase";
                        $phrase.appendChild(createSpeakButton(t, TL[b.lang]));
                        const $t = document.createElement("div");
                        $t.className = "content";
                        $t.textContent = t;
                        $phrase.appendChild($t);
                        $alts.appendChild($phrase);
                    } else {
                        const $t = document.createElement("div");
                        $t.className = "content";
                        $t.textContent = t;
                        $alts.appendChild($t);
                    }
                }
                $sec.appendChild($alts);
            }

        $card.appendChild($sec);
        }

        // æ“ä½œï¼ˆå‰Šé™¤ï¼‰ï¼‹ ãƒ¡ã‚¿ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹
        const $footer = document.createElement("div");
        $footer.className = "row"; // â† æ—¢ã«å®šç¾©æ¸ˆã¿ã®flexãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆ©ç”¨

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const $del = document.createElement("button");
        $del.className = "btn danger";
        $del.innerHTML = `<img src="assets/img/batsu.svg" alt="ãƒãƒ„" width="15" style="display:flex">`;
        $del.onclick = () => {
            if (confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                const arr = loadPosts().filter(x => x.id !== p.id);
                savePosts(arr);
                renderList();
            }
        };

        // æ—¥æ™‚
        const $meta = document.createElement("div");
        $meta.className = "meta";
        $meta.textContent = new Date(p.created).toLocaleString();

        // æ¨ªä¸¦ã³ã§footerã«è¿½åŠ 
        $footer.appendChild($del);
        $footer.appendChild($meta);
        $card.appendChild($footer);

        $list.appendChild($card);
    }
}

// åˆæœŸæç”»
renderList();

/** =============== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/å…¨å‰Šé™¤ï¼‰ =============== */
document.getElementById("exportBtn").onclick = ()=>{
    const data = JSON.stringify(loadPosts());
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    a.download = `myspeak_backup_${ts}.json`;
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
};

const $importFile = document.getElementById("importFile");
document.getElementById("importBtn").onclick = ()=> $importFile.click();
$importFile.onchange = async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const txt = await file.text();
    try{
        const arr = JSON.parse(txt);
        if(!Array.isArray(arr)) throw new Error("å½¢å¼ãŒä¸æ­£ã§ã™");
        savePosts(arr);
        renderList();
        alert("å¾©å…ƒã—ã¾ã—ãŸã€‚");
    }catch(err){
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    } finally {
        e.target.value = "";
    }
};

document.getElementById("purgeBtn").onclick = ()=>{
    if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆæŠ•ç¨¿ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
        localStorage.removeItem(DB_KEY);
        renderList();
    }
};

/** =============== PWA: SWç™»éŒ²ï¼ˆä»»æ„ï¼‰ =============== */
if("serviceWorker" in navigator){
    window.addEventListener("load", ()=>{
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
}
</script>
</body>
</html>