<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F2EFF4">
<title>Mew</title>
<style>
:root { --gap:12px; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --bg:#F2EFF4; }
* { font-size:16px; box-sizing: border-box; }
html{background:var(--bg);}
body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:#f3dadf; }
header { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 14px; display:flex; align-items:center; gap:10px; z-index:2; }
header h1 { font-size:1.1rem; margin:0; }
main { max-width:720px; margin:0 auto; padding:14px; }

.fab {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #ae4a74;
    color: #fff;
    border: none;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    font-size: 1.6rem;
    cursor: pointer;
    z-index: 3;
}

.modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 4;
}

.modal.open { display:flex; }

.modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.35);
}

.modal-body {
    position: relative;
    max-width: 780px;
    width: calc(100% - 24px);
    margin: 0 auto;
    z-index: 1;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    padding: 12px 0;
}

.composer-header {
    display:flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.composer-header h3 { margin: 0; font-size:1.05rem; }

.composer-close {
    border: none;
    background: none;
    cursor: pointer;
    padding: 6px;
}

.card { background:var(--card); border-radius:14px; padding:12px; }
.composer { display:grid; gap:var(--gap); max-height: calc(90vh - 24px); overflow-y: auto; }
textarea { font-size: 16px; width:100%; min-height:96px; padding:10px; resize:vertical; border: 2px solid #e8e3ec96; border-radius: 10px; }
.row { display:flex; flex-wrap:wrap; gap:40px; align-items:center; justify-content: space-between; }
.lang-chip { display:none; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fafafa; }
.langBox { display: flex; justify-content: space-between; }
.btn { text-decoration: none; padding:0; border:none; border-radius:20px; box-sizing: border-box; background:none; cursor:pointer; display: flex; align-items: center;}
.btn_img { border: none; }
.btn:active { transform: translateY(1px); }
.btn.lang { color:#000; border: 1px solid #ccc; padding: 4px 10px; gap: 4px;}
.btn.primary { border: 2px solid #ae4a74; background:#ae4a74; color:#fff; padding: 3px 40px; gap: 5px;}
.btn.clear { border: 2px solid #ae4a74; color:#ae4a74; padding: 3px 20px; }
.btn.danger { border-color:#ef4444; color:#ef4444; }
.small { font-size:.9rem; color:var(--muted); }
.grid { display:grid; gap:10px; }
.post { display:grid; gap:8px; }
.meta { display:flex; gap:8px; color:var(--muted); font-size:.9rem; }
.content { white-space:pre-wrap; word-break:break-word; }
.img { width:100%; border-radius:12px; border:1px solid var(--border); background:#f3f4f6; object-fit:cover; max-height:420px; }
.section { border: none; background: #e8e3ec52; border-radius:12px; padding:10px; }
details summary { cursor:pointer; }
.toolbar { display:flex; gap:40px; margin-top:8px; padding: 5px 12px;}
.list { display:grid; gap:2rem; margin-top:12px; }
.phrase { display:flex; align-items:center; gap:5px; }
.sep { height:1px; background:var(--border); margin:8px 0; }
.pill { font-size:.9rem; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#f9fafb; }
.lang-block { padding:10px; border-radius:10px; background: #e8e3ec52; }
.lang-block h4 { margin:0 0 6px; font-size:.9rem; display:flex; justify-content:space-between; }
.hl { font-weight:600; }
.actions { display:flex; gap:8px; flex-wrap:wrap; }
.notice { font-size:.9rem; background:#fff; color:#ae4a74; padding:10px; border-radius:10px; }
.other { padding-top: 10px; display: flex; flex-direction: column; gap: 8px; padding-left: 15px;}
.meta {flex-grow: 1; display: flex; justify-content: end;}
.post { border: 2px solid #48a0cc; box-shadow: 5px 5px 0 0 #f3dadf, 7px 7px 0 0 #48a0cc; }
.image-actions { display:flex; justify-content:flex-end; }
</style>
</head>
<body>

<!-- ä»»æ„: ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã†å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤
<header>
<h1>My Speak SNSï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ï¼‰</h1>
<span class="pill">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³OK</span>
</header>
-->

<main>
    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="list" id="list"></div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ/å…¨å‰Šé™¤ï¼‰ -->
    <div class="toolbar">
        <button class="btn danger" id="purgeBtn" title="å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤"><img src="assets/img/batsu.svg" alt="ãƒãƒ„" width="18" style="display:flex"></button>
        <button class="btn" id="exportBtn" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"><img src="assets/img/export.svg" alt="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ" width="18" style="display:flex"></button>
        <input type="file" id="importFile" accept="application/json" style="display:none;">
        <button class="btn" id="importBtn" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"><img src="assets/img/import.svg" alt="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ" width="18" style="display:flex"></button>
    </div>

    <p class="small">ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å³ä¸‹ã®ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
</main>

<button class="fab" id="openComposer" aria-label="ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ">ï¼‹</button>

<div class="modal" id="composerModal" aria-hidden="true">
    <div class="modal-backdrop" data-act="close"></div>
    <div class="modal-body">
        <div class="card composer">
            <div class="composer-header">
                <h3 id="composerTitle">æ–°è¦ã‚«ãƒ¼ãƒ‰</h3>
                <button class="composer-close" id="closeComposer" aria-label="é–‰ã˜ã‚‹">
                    <img src="assets/img/batsu.svg" alt="é–‰ã˜ã‚‹" width="18" style="display:flex">
                </button>
            </div>

            <img id="preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width:100%;margin-top:8px;border-radius:12px;display:none;">
            <div class="image-actions">
                <button class="btn clear" id="removeImage" style="display:none;">ç”»åƒã‚’å‰Šé™¤</button>
            </div>

            <div class="grid">
                <div class="langBox">
                    <label for="image" class="btn btn_img" title="ç”»åƒã‚’é¸æŠ">
                    <img src="assets/img/img.svg" alt="ç”»åƒã‚’é¸æŠ" style="width:24px;height:24px;vertical-align:middle;">
                    </label>
                    <input id="image" type="file" accept="image/*" style="display:none;">
                    <button class="btn lang" id="addJa"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="18" style="display:flex">ja</button>
                    <button class="btn lang" id="addEn"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="18" style="display:flex">en</button>
                    <button class="btn lang" id="addKo"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="18" style="display:flex">ko</button>
                    <button class="btn lang" id="addZh"><img src="assets/img/plus.svg" alt="ãƒ—ãƒ©ã‚¹" width="18" style="display:flex">zh-TW</button>
                </div>
                <div id="langArea" class="grid"></div>
            </div>

            <div class="row">
                <button class="btn clear" id="clearComposer">Clear</button>
                <button class="btn primary" id="postBtn"><img src="assets/img/cat.svg" alt="cat" width="18" style="display:flex">Post</button>
            </div>
        </div>
    </div>
</div>

<script>
/** ================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ================== */
const DB_KEY = "myspeak_sns_posts_v1";
const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; // iOS åˆ¤å®š
const TL = { "ja":"ja", "ko":"ko", "zh-TW":"zh-TW", "en":"en" }; // Googleç¿»è¨³ã® tl
const MAX_BLOCKS = 3;
const DEFAULT_LANG = "ja";

function buildTranslateLinks(text, tl){
    const encoded = encodeURIComponent(text);
    const app = `googletranslate://?sl=auto&tl=${encodeURIComponent(tl)}&text=${encoded}`;
    const web = `https://translate.google.com/?sl=auto&tl=${encodeURIComponent(tl)}&text=${encoded}&op=translate`;
    return { app, web };
}

/*
// iOS: ã¾ãšã‚¢ãƒ—ãƒª â†’ å¤±æ•—æ™‚ Web ã¸ã®å®‰å®šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
function createSpeakButton(text, tl) {
    const { app, web } = buildTranslateLinks(text, tl);
    const a = document.createElement("a");
    a.className = "btn";
    a.innerHTML = `<img src="assets/img/speaker.svg" alt="ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼" width="18" style="display:flex">`;

    // iOS ä»¥å¤–ã¯å˜ç´”ã« Web ã¸
    if (!isiOS) {
        a.href = web;
        a.target = "_blank";
        a.rel = "noopener";
        return a;
    }

    // iOS: ã¾ãšã‚¢ãƒ—ãƒª â†’ å¤±æ•—æ™‚ Web
    a.href = app; // é•·æŠ¼ã—å¯¾ç­–

    a.addEventListener("click", (e) => {
        e.preventDefault();

        let openedByApp = false;
        const handleVisibility = () => {
            if (document.hidden) {
                openedByApp = true;
                cleanup();
            }
        };

        // â˜… ã“ã“ã‹ã‚‰å…ˆã¯ã€Œã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã€ã«ã ã‘ã‚»ãƒƒãƒˆã™ã‚‹
        document.addEventListener("visibilitychange", handleVisibility, { once: true });

        const t = setTimeout(() => {
            if (!openedByApp) {
                window.open(web, "_blank", "noopener"); // ã‚¢ãƒ—ãƒªç„¡ã„/å¤±æ•— â†’ Web
            }
            cleanup();
        }, 700);

        function cleanup() {
            clearTimeout(t);
            document.removeEventListener("visibilitychange", handleVisibility);
        }

        // ã¾ãšã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«é–‹ã
        window.location.href = app;
    });

    return a;
}
    */
    
// iOS: ã¾ãšã‚¢ãƒ—ãƒª â†’ å¤±æ•—æ™‚ã ã‘Webï¼ˆblur/pagehide/visibilitychange + çµŒéæ™‚é–“ã§ç¢ºå®Ÿã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
function createSpeakButton(text, tl) {
  const { app, web } = buildTranslateLinks(text, tl);
  const a = document.createElement("a");
  a.className = "btn";
  a.innerHTML = `<img src="assets/img/speaker.svg" alt="ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼" width="18" style="display:flex">`;

  // iOSä»¥å¤–ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«Webã‚’æ–°è¦ã‚¿ãƒ–ã§
  if (!isiOS) {
    a.href = web;
    a.target = "_blank";
    a.rel = "noopener";
    return a;
  }

  // --- iOSç”¨: ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã ã‘ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ï¼†ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¶å¾¡ ---
  // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒä¸è¦ãªã‚‰ a.href ã¯ä»˜ã‘ãªã„æ–¹ãŒå®‰å…¨ï¼ˆèª¤å‹•ä½œé˜²æ­¢ï¼‰
  // a.href = app; // â†é•·æŠ¼ã—ã§ã€Œãƒªãƒ³ã‚¯ã‚’é–‹ãã€ã‚’å‡ºã—ãŸã„å ´åˆã ã‘æœ‰åŠ¹åŒ–

  a.addEventListener("click", (e) => {
    e.preventDefault();

    let done = false;        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä¸€åº¦ã ã‘ã«ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
    const start = Date.now();

    const cleanup = () => {
      done = true;
      window.removeEventListener("blur", onBlur, true);
      window.removeEventListener("pagehide", onPageHide, true);
      document.removeEventListener("visibilitychange", onVis, true);
    };

    const onBlur = () => { cleanup(); };                  // å¤–éƒ¨ã‚¢ãƒ—ãƒªã«é·ç§»ã™ã‚‹ã¨ã ã„ãŸã„ blur ã™ã‚‹
    const onPageHide = () => { cleanup(); };              // ã‚¿ãƒ–é·ç§»ã§ç™ºç«ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹
    const onVis = () => { if (document.hidden) cleanup(); };

    window.addEventListener("blur", onBlur, true);
    window.addEventListener("pagehide", onPageHide, true);
    document.addEventListener("visibilitychange", onVis, true);

    // ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å®Ÿè¡Œ
    // â€» setTimeout(0) ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ä¸€åº¦æŠœã‘ã‚‹ã¨æŒ™å‹•ãŒå®‰å®šã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹
    setTimeout(() => { window.location.href = app; }, 0);

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰ï¼š1.2ã€œ1.5ç§’ãã‚‰ã„ãŒå®Ÿé‹ç”¨ã§å®‰å®š
    const FALLBACK_MS = 1300;
    setTimeout(() => {
      if (done) return; // ã™ã§ã«ã‚¢ãƒ—ãƒªé·ç§»ã§ããŸ
      // çµŒéæ™‚é–“ãŒçŸ­ãã€ã‹ã¤ hidden/blur/pagehide ã‚‚æ¥ã¦ã„ãªã„ â†’ ã‚¢ãƒ—ãƒªèµ·å‹•å¤±æ•—ã¨ã¿ãªã™
      const elapsed = Date.now() - start;
      if (elapsed >= FALLBACK_MS) {
        // PWAå†…ã§é–‹ãã¨æˆ»ã‚Œãªããªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ target=_blank æ¨å¥¨
        window.open(web, "_blank", "noopener");
      }
      cleanup();
    }, FALLBACK_MS);
  });

  return a;
}


function loadPosts(){ try { return JSON.parse(localStorage.getItem(DB_KEY) || "[]"); } catch { return []; } }
function savePosts(arr){ localStorage.setItem(DB_KEY, JSON.stringify(arr)); }

function fileToDataURL(file){
    return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
    });
}
function rid(){ return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2); }

/** =============== ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè¨€èªãƒ–ãƒ­ãƒƒã‚¯ï¼‰ =============== */
const $composerModal = document.getElementById("composerModal");
const $composerTitle = document.getElementById("composerTitle");
const $openComposer = document.getElementById("openComposer");
const $closeComposer = document.getElementById("closeComposer");
const $langArea = document.getElementById("langArea");
let editingId = null;
let currentImageData = "";

function setPostButtonLabel(isEdit){
    const label = isEdit ? "Update" : "Post";
    $postBtn.innerHTML = `<img src="assets/img/cat.svg" alt="cat" width="18" style="display:flex"> ${label}`;
}

function updateLangButtons(){
    const disabled = $langArea.childElementCount >= MAX_BLOCKS;
    document.querySelectorAll(".btn.lang").forEach(btn => {
        btn.disabled = disabled;
        btn.setAttribute("aria-disabled", disabled ? "true" : "false");
    });
}

function addLangBlock(lang, data = {}, opts = {}){
    const { removable = $langArea.childElementCount > 0, skipLimit = false } = opts;
    if(!skipLimit && $langArea.childElementCount >= MAX_BLOCKS){
        alert(`å…¥åŠ›æ¬„ã¯æœ€å¤§${MAX_BLOCKS}ã¤ã¾ã§ã§ã™ã€‚`);
        return null;
    }
    const id = rid();
    const $wrap = document.createElement("div");
    $wrap.className = "lang-block";
    $wrap.dataset.lang = lang;
    $wrap.dataset.id = id;
    $wrap.dataset.removable = removable ? "true" : "false";
    const removeBtn = removable ? `<button class="btn small" data-act="remove"><img src="assets/img/batsu.svg" alt="ãƒãƒ„" width="18" style="display:flex"></button>` : "";
    $wrap.innerHTML = `
        <h4>${langLabel(lang)} ${removeBtn}</h4>
        <div class="grid">
        <label><textarea data-field="main" placeholder="ä¾‹ï¼‰I had ramen for lunch.">${data.main ?? ""}</textarea></label>
        </div>
    `;
    $wrap.addEventListener("click", (e)=>{
        if(e.target.closest("[data-act='remove']")){
            if($wrap.dataset.removable === "true"){
                $wrap.remove();
                updateLangButtons();
            }
        }
    });
    $langArea.appendChild($wrap);
    updateLangButtons();
    return $wrap;
}
function langLabel(lang){
    switch(lang){
        case "ja": return "æ—¥æœ¬èªï¼ˆja)";
        case "ko": return "éŸ“å›½èªï¼ˆko)";
        case "zh-TW": return "å°æ¹¾è¯èªï¼ˆzh-TW)";
        case "en": return "è‹±èªï¼ˆen)";
        default: return lang;
    }
}

function resetComposer(opts = {}){
    const { addDefault = true } = opts;
    editingId = null;
    clearImagePreview();
    $langArea.innerHTML = "";
    $composerTitle.textContent = "æ–°è¦ã‚«ãƒ¼ãƒ‰";
    setPostButtonLabel(false);
    if(addDefault){
        addLangBlock(DEFAULT_LANG, {}, { skipLimit: true, removable: false });
    } else {
        updateLangButtons();
    }
}

function closeComposer(){
    $composerModal.classList.remove("open");
    $composerModal.setAttribute("aria-hidden", "true");
}

function openComposer(post = null){
    resetComposer({ addDefault: !post });
    if(post){
        editingId = post.id;
        currentImageData = post.image || "";
        if(currentImageData){
            $preview.src = currentImageData;
            $preview.style.display = "block";
            $removeImage.style.display = "inline-flex";
        }
        const blocks = Array.isArray(post.blocks) ? post.blocks : [];
        if(blocks.length){
            blocks.forEach((b, idx) => addLangBlock(b.lang, b, { skipLimit: true, removable: idx !== 0 }));
        } else {
            addLangBlock(DEFAULT_LANG, {}, { skipLimit: true, removable: false });
        }
        $composerTitle.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†";
        setPostButtonLabel(true);
    } else {
        updateLangButtons();
    }
    $composerModal.classList.add("open");
    $composerModal.setAttribute("aria-hidden", "false");
}

/** =============== ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =============== */
const $image = document.getElementById("image");
const $preview = document.getElementById("preview");
const $removeImage = document.getElementById("removeImage");

function clearImagePreview(){
    currentImageData = "";
    $image.value = "";
    $preview.style.display = "none";
    $preview.src = "";
    $removeImage.style.display = "none";
}

$removeImage.addEventListener("click", (e)=>{
    e.preventDefault();
    clearImagePreview();
});

$image.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const dataUrl = await fileToDataURL(file);
        currentImageData = dataUrl;
        $preview.src = dataUrl;
        $preview.style.display = "block";
        $removeImage.style.display = "inline-flex";
    } catch {
        alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
});

/** =============== æŠ•ç¨¿ä½œæˆ =============== */
const $postBtn = document.getElementById("postBtn");
const $clearComposer = document.getElementById("clearComposer");
document.getElementById("addJa").onclick = ()=>addLangBlock("ja");
document.getElementById("addKo").onclick = ()=>addLangBlock("ko");
document.getElementById("addZh").onclick = ()=>addLangBlock("zh-TW");
document.getElementById("addEn").onclick = ()=>addLangBlock("en");
$openComposer.addEventListener("click", ()=>openComposer());
$closeComposer.addEventListener("click", ()=>{ resetComposer(); closeComposer(); });
$composerModal.addEventListener("click", (e)=>{
    if(e.target?.dataset?.act === "close"){ resetComposer(); closeComposer(); }
});

$postBtn.addEventListener("click", async ()=>{
    const blocks = Array.from($langArea.querySelectorAll(".lang-block")).map($b=>{
        const lang = $b.dataset.lang;
        const get = (sel)=>($b.querySelector(`[data-field='${sel}']`)?.value || "").trim();
        const main = get("main");
        return { lang, main };
    }).filter(b=>b.lang && b.main);

    if(!blocks.length){ alert("å°‘ãªãã¨ã‚‚1ã¤ã®è¨€èªãƒ–ãƒ­ãƒƒã‚¯ã§ã€ãƒ¡ã‚¤ãƒ³ã®è¨€è‘‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

    const posts = loadPosts();
    if(editingId){
        const idx = posts.findIndex(x => x.id === editingId);
        if(idx >= 0){
            posts[idx] = { ...posts[idx], image: currentImageData, blocks };
        }
    } else {
        posts.push({ id: rid(), created: Date.now(), image: currentImageData, blocks });
    }
    savePosts(posts);

    resetComposer();
    closeComposer();
    renderList();
});

$clearComposer.addEventListener("click", ()=>{ resetComposer(); });

resetComposer();
closeComposer();

/** =============== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» =============== */
const $list = document.getElementById("list");
function renderList(){
    const posts = loadPosts().sort((a,b)=>b.created - a.created);
    $list.innerHTML = "";

    if(!posts.length){
        const $n = document.createElement("div");
        $n.className = "notice";
        $n.textContent = "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸‹ã®ã€ï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚";
        $list.appendChild($n);
        return;
    }

    for(const p of posts){
        const $card = document.createElement("div");
        $card.className = "card post";

        if(p.image){
            const $img = document.createElement("img");
            $img.className = "img";
            $img.src = p.image;
            $img.alt = "æŠ•ç¨¿ç”»åƒ";
            $card.appendChild($img);
        }

        for(const b of p.blocks){
            const $sec = document.createElement("div");
            $sec.className = "section";

            // è¨€èªãƒ©ãƒ™ãƒ«
            const $title = document.createElement("div");
            $title.className = "row";
            const $chip = document.createElement("span");
            $chip.className = "lang-chip";
            $chip.textContent = langLabel(b.lang);
            $title.appendChild($chip);
            $sec.appendChild($title);

            // æœ¬æ–‡ï¼ˆğŸ”Šâ†’ãƒ†ã‚­ã‚¹ãƒˆï¼‰
            const mainStr = (b.main ?? "").toString().trim();
            if (mainStr) {
                const $mainRow = document.createElement("div");
                $mainRow.className = "phrase";
                if (b.lang !== "ja") $mainRow.appendChild(createSpeakButton(mainStr, TL[b.lang]));
                const $mainText = document.createElement("div");
                $mainText.className = "content";
                $mainText.textContent = mainStr;
                $mainRow.appendChild($mainText);
                $sec.appendChild($mainRow);
            }

        $card.appendChild($sec);
        }

        // æ“ä½œï¼ˆå‰Šé™¤ï¼‰ï¼‹ ãƒ¡ã‚¿ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹
        const $footer = document.createElement("div");
        $footer.className = "row"; // â† æ—¢ã«å®šç¾©æ¸ˆã¿ã®flexãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆ©ç”¨

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const $del = document.createElement("button");
        $del.className = "btn danger";
        $del.innerHTML = `<img src="assets/img/batsu.svg" alt="Delete" width="18" style="display:flex">`;
        $del.onclick = () => {
            if (confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                const arr = loadPosts().filter(x => x.id !== p.id);
                savePosts(arr);
                renderList();
            }
        };

        // Editãƒœã‚¿ãƒ³
        const $edit = document.createElement("button");
        $edit.className = "btn";
        $edit.innerHTML = `<img src="assets/img/edit.svg" alt="Edit" width="18" style="display:flex">`;
        $edit.onclick = () => openComposer(p);

        // æ—¥æ™‚
        const $meta = document.createElement("div");
        $meta.className = "meta";
        $meta.textContent = new Date(p.created).toLocaleString();

        // æ¨ªä¸¦ã³ã§footerã«è¿½åŠ 
        $footer.appendChild($del);
        $footer.appendChild($edit);
        $footer.appendChild($meta);
        $card.appendChild($footer);

        $list.appendChild($card);
    }
}

// åˆæœŸæç”»
renderList();

/** =============== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/å…¨å‰Šé™¤ï¼‰ =============== */
document.getElementById("exportBtn").onclick = ()=>{
    const data = JSON.stringify(loadPosts());
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    a.download = `myspeak_backup_${ts}.json`;
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
};

const $importFile = document.getElementById("importFile");
document.getElementById("importBtn").onclick = ()=> $importFile.click();
$importFile.onchange = async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const txt = await file.text();
    try{
        const arr = JSON.parse(txt);
        if(!Array.isArray(arr)) throw new Error("å½¢å¼ãŒä¸æ­£ã§ã™");
        savePosts(arr);
        renderList();
        alert("å¾©å…ƒã—ã¾ã—ãŸã€‚");
    }catch(err){
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    } finally {
        e.target.value = "";
    }
};

document.getElementById("purgeBtn").onclick = ()=>{
    if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆæŠ•ç¨¿ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
        localStorage.removeItem(DB_KEY);
        renderList();
    }
};

/** =============== PWA: SWç™»éŒ²ï¼ˆä»»æ„ï¼‰ =============== */
if("serviceWorker" in navigator){
    window.addEventListener("load", ()=>{
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
}
</script>
</body>
</html>
